name: Deploy Backend

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Copy Files to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || '22' }}
        source: "backend/*"
        target: "/var/www/api.effmemberportal.org/backend"
        rm: false

    - name: Install & Reload via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || '22' }}
        script: |
          cd /var/www/api.effmemberportal.org/backend
          
          # Install Dependencies
          npm install --production
          
          # Database Migrations (Connects to Dockerized DB via .env)
          npx prisma migrate deploy
          
          # Build TypeScript
          npm run build
          
          # Restart PM2
          pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production
          pm2 save
