<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geographic Selector Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            background-color: white;
        }
        select:disabled {
            background-color: #f5f5f5;
            color: #666;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .error {
            color: #d32f2f;
            font-size: 14px;
            margin-top: 5px;
        }
        .success {
            color: #2e7d32;
            font-size: 14px;
            margin-top: 5px;
        }
        .hierarchy {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            border-left: 4px solid #2196f3;
        }
        .test-button {
            background-color: #1976d2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background-color: #1565c0;
        }
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Geographic Selector Test</h1>
        <p>This page tests the hierarchical geographic selection functionality for the membership application form.</p>
        
        <div class="test-buttons">
            <button class="test-button" onclick="testApiEndpoints()">Test API Endpoints</button>
            <button class="test-button" onclick="clearSelections()">Clear All</button>
            <button class="test-button" onclick="testHierarchy()">Test Full Hierarchy</button>
        </div>
        
        <div id="testResults" class="test-results" style="display: none;">
            <h3>Test Results</h3>
            <div id="resultsContent"></div>
        </div>
        
        <form id="geographicForm">
            <div class="form-group">
                <label for="province">Province *</label>
                <select id="province" onchange="onProvinceChange()">
                    <option value="">Select a province...</option>
                </select>
                <div id="provinceError" class="error"></div>
            </div>
            
            <div class="form-group">
                <label for="district">District *</label>
                <select id="district" onchange="onDistrictChange()" disabled>
                    <option value="">Select a province first...</option>
                </select>
                <div id="districtError" class="error"></div>
            </div>
            
            <div class="form-group">
                <label for="municipality">Municipality *</label>
                <select id="municipality" onchange="onMunicipalityChange()" disabled>
                    <option value="">Select a district first...</option>
                </select>
                <div id="municipalityError" class="error"></div>
            </div>
            
            <div class="form-group">
                <label for="ward">Ward *</label>
                <select id="ward" onchange="onWardChange()" disabled>
                    <option value="">Select a municipality first...</option>
                </select>
                <div id="wardError" class="error"></div>
            </div>
            
            <div class="form-group">
                <label for="votingDistrict">Voting District *</label>
                <select id="votingDistrict" onchange="onVotingDistrictChange()" disabled>
                    <option value="">Select a ward first...</option>
                </select>
                <div id="votingDistrictError" class="error"></div>
            </div>
        </form>
        
        <div id="hierarchy" class="hierarchy" style="display: none;">
            <h3>Selected Location Hierarchy</h3>
            <div id="hierarchyContent"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api/v1';
        let selectedData = {
            province: null,
            district: null,
            municipality: null,
            ward: null,
            votingDistrict: null
        };

        // Utility functions
        function showLoading(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Loading...</option>';
            select.disabled = true;
        }

        function showError(elementId, message) {
            document.getElementById(elementId).textContent = message;
        }

        function clearError(elementId) {
            document.getElementById(elementId).textContent = '';
        }

        function updateHierarchy() {
            const hierarchyDiv = document.getElementById('hierarchy');
            const contentDiv = document.getElementById('hierarchyContent');
            
            if (!selectedData.province) {
                hierarchyDiv.style.display = 'none';
                return;
            }
            
            let hierarchy = selectedData.province.province_name;
            if (selectedData.district) hierarchy += ` → ${selectedData.district.district_name}`;
            if (selectedData.municipality) hierarchy += ` → ${selectedData.municipality.municipality_name}`;
            if (selectedData.ward) hierarchy += ` → Ward ${selectedData.ward.ward_number} (${selectedData.ward.ward_name})`;
            if (selectedData.votingDistrict) hierarchy += ` → VD ${selectedData.votingDistrict.voting_district_number} (${selectedData.votingDistrict.voting_district_name})`;
            
            contentDiv.textContent = hierarchy;
            hierarchyDiv.style.display = 'block';
        }

        // API functions
        async function fetchData(url) {
            try {
                const response = await fetch(`${API_BASE}${url}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Load provinces on page load
        async function loadProvinces() {
            try {
                showLoading('province');
                const data = await fetchData('/geographic/provinces');
                const select = document.getElementById('province');
                
                select.innerHTML = '<option value="">Select a province...</option>';
                data.data.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.province_code;
                    option.textContent = province.province_name;
                    option.dataset.province = JSON.stringify(province);
                    select.appendChild(option);
                });
                
                select.disabled = false;
                clearError('provinceError');
            } catch (error) {
                showError('provinceError', 'Failed to load provinces');
                console.error('Error loading provinces:', error);
            }
        }

        // Event handlers
        async function onProvinceChange() {
            const select = document.getElementById('province');
            const provinceCode = select.value;
            
            // Reset dependent selections
            resetSelect('district', 'Select a province first...');
            resetSelect('municipality', 'Select a district first...');
            resetSelect('ward', 'Select a municipality first...');
            resetSelect('votingDistrict', 'Select a ward first...');
            
            selectedData.district = null;
            selectedData.municipality = null;
            selectedData.ward = null;
            selectedData.votingDistrict = null;
            
            if (!provinceCode) {
                selectedData.province = null;
                updateHierarchy();
                return;
            }
            
            selectedData.province = JSON.parse(select.selectedOptions[0].dataset.province);
            updateHierarchy();
            
            // Load districts
            try {
                showLoading('district');
                const data = await fetchData(`/geographic/districts?province=${provinceCode}`);
                const districtSelect = document.getElementById('district');
                
                districtSelect.innerHTML = '<option value="">Select a district...</option>';
                data.data.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.district_code;
                    option.textContent = district.district_name;
                    option.dataset.district = JSON.stringify(district);
                    districtSelect.appendChild(option);
                });
                
                districtSelect.disabled = false;
                clearError('districtError');
            } catch (error) {
                showError('districtError', 'Failed to load districts');
            }
        }

        async function onDistrictChange() {
            const select = document.getElementById('district');
            const districtCode = select.value;
            
            // Reset dependent selections
            resetSelect('municipality', 'Select a district first...');
            resetSelect('ward', 'Select a municipality first...');
            resetSelect('votingDistrict', 'Select a ward first...');
            
            selectedData.municipality = null;
            selectedData.ward = null;
            selectedData.votingDistrict = null;
            
            if (!districtCode) {
                selectedData.district = null;
                updateHierarchy();
                return;
            }
            
            selectedData.district = JSON.parse(select.selectedOptions[0].dataset.district);
            updateHierarchy();
            
            // Load municipalities
            try {
                showLoading('municipality');
                const data = await fetchData(`/geographic/municipalities?district=${districtCode}`);
                const municipalitySelect = document.getElementById('municipality');
                
                municipalitySelect.innerHTML = '<option value="">Select a municipality...</option>';
                data.data.forEach(municipality => {
                    const option = document.createElement('option');
                    option.value = municipality.municipality_code;
                    option.textContent = municipality.municipality_name;
                    option.dataset.municipality = JSON.stringify(municipality);
                    municipalitySelect.appendChild(option);
                });
                
                municipalitySelect.disabled = false;
                clearError('municipalityError');
            } catch (error) {
                showError('municipalityError', 'Failed to load municipalities');
            }
        }

        async function onMunicipalityChange() {
            const select = document.getElementById('municipality');
            const municipalityCode = select.value;

            // Reset dependent selections
            resetSelect('ward', 'Select a municipality first...');
            resetSelect('votingDistrict', 'Select a ward first...');

            selectedData.ward = null;
            selectedData.votingDistrict = null;

            if (!municipalityCode) {
                selectedData.municipality = null;
                updateHierarchy();
                return;
            }

            selectedData.municipality = JSON.parse(select.selectedOptions[0].dataset.municipality);
            updateHierarchy();

            // Load wards
            try {
                showLoading('ward');
                const data = await fetchData(`/geographic/wards?municipality=${municipalityCode}`);
                const wardSelect = document.getElementById('ward');

                wardSelect.innerHTML = '<option value="">Select a ward...</option>';
                data.data.forEach(ward => {
                    const option = document.createElement('option');
                    option.value = ward.ward_code;
                    option.textContent = `Ward ${ward.ward_number} - ${ward.ward_name}`;
                    option.dataset.ward = JSON.stringify(ward);
                    wardSelect.appendChild(option);
                });

                wardSelect.disabled = false;
                clearError('wardError');
            } catch (error) {
                showError('wardError', 'Failed to load wards');
            }
        }

        async function onWardChange() {
            const select = document.getElementById('ward');
            const wardCode = select.value;

            // Reset dependent selections
            resetSelect('votingDistrict', 'Select a ward first...');
            selectedData.votingDistrict = null;

            if (!wardCode) {
                selectedData.ward = null;
                updateHierarchy();
                return;
            }

            selectedData.ward = JSON.parse(select.selectedOptions[0].dataset.ward);
            updateHierarchy();

            // Load voting districts
            try {
                showLoading('votingDistrict');
                const data = await fetchData(`/geographic/voting-districts/by-ward/${wardCode}`);
                const votingDistrictSelect = document.getElementById('votingDistrict');

                if (data.data.length === 0) {
                    votingDistrictSelect.innerHTML = '<option value="">No voting districts available</option>';
                    votingDistrictSelect.disabled = true;
                } else {
                    votingDistrictSelect.innerHTML = '<option value="">Select a voting district...</option>';
                    data.data.forEach(vd => {
                        const option = document.createElement('option');
                        option.value = vd.voting_district_code;
                        option.textContent = `VD ${vd.voting_district_number} - ${vd.voting_district_name}`;
                        option.dataset.votingDistrict = JSON.stringify(vd);
                        votingDistrictSelect.appendChild(option);
                    });
                    votingDistrictSelect.disabled = false;
                }

                clearError('votingDistrictError');
            } catch (error) {
                showError('votingDistrictError', 'Failed to load voting districts');
            }
        }

        function onVotingDistrictChange() {
            const select = document.getElementById('votingDistrict');
            const votingDistrictCode = select.value;

            if (!votingDistrictCode) {
                selectedData.votingDistrict = null;
            } else {
                selectedData.votingDistrict = JSON.parse(select.selectedOptions[0].dataset.votingDistrict);
            }

            updateHierarchy();
        }

        function resetSelect(selectId, placeholder) {
            const select = document.getElementById(selectId);
            select.innerHTML = `<option value="">${placeholder}</option>`;
            select.disabled = true;
        }

        // Test functions
        async function testApiEndpoints() {
            const resultsDiv = document.getElementById('testResults');
            const contentDiv = document.getElementById('resultsContent');

            resultsDiv.style.display = 'block';
            contentDiv.innerHTML = '<p>Testing API endpoints...</p>';

            const tests = [
                { name: 'Provinces', url: '/geographic/provinces' },
                { name: 'Districts', url: '/geographic/districts' },
                { name: 'Municipalities', url: '/geographic/municipalities' },
                { name: 'Wards', url: '/geographic/wards?limit=5' }
            ];

            let results = [];

            for (const test of tests) {
                try {
                    const data = await fetchData(test.url);
                    results.push(`✅ ${test.name}: ${data.data.length} items`);
                } catch (error) {
                    results.push(`❌ ${test.name}: ${error.message}`);
                }
            }

            contentDiv.innerHTML = results.map(r => `<p>${r}</p>`).join('');
        }

        function clearSelections() {
            document.getElementById('province').value = '';
            resetSelect('district', 'Select a province first...');
            resetSelect('municipality', 'Select a district first...');
            resetSelect('ward', 'Select a municipality first...');
            resetSelect('votingDistrict', 'Select a ward first...');

            selectedData = {
                province: null,
                district: null,
                municipality: null,
                ward: null,
                votingDistrict: null
            };

            updateHierarchy();
        }

        async function testHierarchy() {
            const resultsDiv = document.getElementById('testResults');
            const contentDiv = document.getElementById('resultsContent');

            resultsDiv.style.display = 'block';
            contentDiv.innerHTML = '<p>Testing hierarchical flow...</p>';

            try {
                // Get first province
                const provinces = await fetchData('/geographic/provinces');
                if (provinces.data.length === 0) throw new Error('No provinces found');

                const province = provinces.data[0];
                document.getElementById('province').value = province.province_code;
                await onProvinceChange();

                // Get first district
                const districts = await fetchData(`/geographic/districts?province=${province.province_code}`);
                if (districts.data.length === 0) throw new Error('No districts found');

                const district = districts.data[0];
                document.getElementById('district').value = district.district_code;
                await onDistrictChange();

                contentDiv.innerHTML = '<p>✅ Hierarchical test completed successfully!</p>';
            } catch (error) {
                contentDiv.innerHTML = `<p>❌ Hierarchical test failed: ${error.message}</p>`;
            }
        }

        // Initialize on page load
        window.addEventListener('load', loadProvinces);
    </script>
</body>
</html>
