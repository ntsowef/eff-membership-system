import { Router, Request, Response, NextFunction } from 'express';
import Joi from 'joi';
import { executeQuery, executeQuerySingle } from '../config/database';
import { ValidationError, NotFoundError, DatabaseError } from '../middleware/errorHandler';
import { sendSuccess } from '../utils/responseHelpers';

const router = Router();

/**
 * Interface for member renewal data
 */
interface MemberRenewalData {
  member_id: number;
  id_number: string;
  firstname: string;
  surname: string;
  middle_name?: string;
  email?: string;
  cell_number?: string;
  landline_number?: string;
  residential_address?: string;
  postal_address?: string;
  ward_code?: string;
  membership_number?: string;
  membership_type?: string;
  date_joined?: string;
  last_payment_date?: string;
  expiry_date?: string;
  status_id?: number;
  status_name?: string;
  province_code?: string;
  province_name?: string;
  district_code?: string;
  district_name?: string;
  municipality_code?: string;
  municipality_name?: string;
  ward_name?: string;
  voting_station_name?: string;
}

/**
 * Interface for renewal payment data
 */
interface RenewalPaymentData {
  id_number: string;
  payment_method: 'Card' | 'Cash' | 'EFT' | 'Mobile' | 'Other';
  payment_reference?: string;
  amount_paid: number;
  updated_member_data?: {
    email?: string;
    cell_number?: string;
    landline_number?: string;
    residential_address?: string;
    postal_address?: string;
    ward_code?: string;
  };
}

/**
 * Validation schema for ID number
 */
const idNumberSchema = Joi.object({
  idNumber: Joi.string().pattern(/^\d{13}$/).required()
    .messages({
      'string.pattern.base': 'ID number must be exactly 13 digits',
      'any.required': 'ID number is required'
    })
});

/**
 * Validation schema for renewal processing
 */
const renewalProcessSchema = Joi.object({
  id_number: Joi.string().pattern(/^\d{13}$/).required()
    .messages({
      'string.pattern.base': 'ID number must be exactly 13 digits',
      'any.required': 'ID number is required'
    }),
  payment_method: Joi.string().valid('Card', 'Cash', 'EFT', 'Mobile', 'Other').required()
    .messages({
      'any.only': 'Payment method must be one of: Card, Cash, EFT, Mobile, Other',
      'any.required': 'Payment method is required'
    }),
  payment_reference: Joi.string().max(100).optional(),
  amount_paid: Joi.number().min(0).required()
    .messages({
      'number.min': 'Amount paid must be a positive number',
      'any.required': 'Amount paid is required'
    }),
  updated_member_data: Joi.object({
    email: Joi.string().email().max(255).optional(),
    cell_number: Joi.string().max(20).optional(),
    landline_number: Joi.string().max(20).optional(),
    residential_address: Joi.string().max(500).optional(),
    postal_address: Joi.string().max(500).optional(),
    ward_code: Joi.string().max(20).optional()
  }).optional()
});

/**
 * GET /api/v1/renewals/member/:idNumber
 * Retrieve member data for renewal by ID number
 */
router.get('/member/:idNumber', async (req: Request, res: Response, next: NextFunction) => {
  try {
    // Validate ID number
    const { error } = idNumberSchema.validate(req.params);
    if (error) {
      throw new ValidationError(error.details[0].message);
    }

    const { idNumber } = req.params;

    // Query member data with ALL relevant information for renewal
    const query = `
      SELECT
        -- Core member fields
        m.member_id, m.id_number, m.firstname, m.surname, m.middle_name,
        m.date_of_birth, m.age,

        -- Demographic information
        m.gender_id, g.gender_name,
        m.race_id, r.race_name,
        m.citizenship_id, c.citizenship_name,
        m.language_id, l.language_name,

        -- Contact information
        m.email, m.cell_number, m.landline_number, m.alternative_contact,
        m.residential_address, m.postal_address,

        -- Geographic information
        m.ward_code, w.ward_name, w.ward_number,
        m.voting_district_code, vd.voting_district_name,
        m.voting_station_id, vs.station_name as voting_station_name, vs.station_code as voting_station_code,
        m.province_code, m.province_name,
        m.district_code, m.district_name,
        m.municipality_code, m.municipality_name,

        -- Professional information
        m.occupation_id, o.occupation_name, oc.category_name as occupation_category,
        m.qualification_id, q.qualification_name,

        -- Voter information
        m.voter_status_id, vst.status_name as voter_status_name,
        m.voter_registration_number, m.voter_registration_date, m.voter_verified_at,

        -- Membership information
        m.membership_type, m.application_id,
        ms.membership_number, ms.date_joined, ms.last_payment_date,
        ms.expiry_date, ms.status_id, mst.status_name as membership_status_name,
        ms.subscription_type_id, st.subscription_name, ms.membership_amount,

        -- Timestamps
        m.created_at as member_created_at, m.updated_at as member_updated_at,
        ms.created_at as membership_created_at, ms.updated_at as membership_updated_at

      FROM members m
      LEFT JOIN memberships ms ON m.member_id = ms.member_id
      LEFT JOIN membership_statuses mst ON ms.status_id = mst.status_id
      LEFT JOIN subscription_types st ON ms.subscription_type_id = st.subscription_type_id

      -- Lookup tables
      LEFT JOIN genders g ON m.gender_id = g.gender_id
      LEFT JOIN races r ON m.race_id = r.race_id
      LEFT JOIN citizenships c ON m.citizenship_id = c.citizenship_id
      LEFT JOIN languages l ON m.language_id = l.language_id
      LEFT JOIN occupations o ON m.occupation_id = o.occupation_id
      LEFT JOIN occupation_categories oc ON o.category_id = oc.category_id
      LEFT JOIN qualifications q ON m.qualification_id = q.qualification_id
      LEFT JOIN voter_statuses vst ON m.voter_status_id = vst.status_id

      -- Geographic tables
      LEFT JOIN wards w ON m.ward_code = w.ward_code
      LEFT JOIN voting_districts vd ON m.voting_district_code = vd.voting_district_code
      LEFT JOIN voting_stations vs ON m.voting_station_id = vs.voting_station_id
      LEFT JOIN municipalities mu ON m.municipality_code = mu.municipality_code
      LEFT JOIN districts d ON m.district_code = d.district_code
      LEFT JOIN provinces p ON m.province_code = p.province_code

      WHERE m.id_number = $1
    `;

    const memberData = await executeQuerySingle<MemberRenewalData>(query, [idNumber]);

    if (!memberData) {
      throw new NotFoundError(`Member with ID number ${idNumber} not found`);
    }

    // Return member data for renewal
    sendSuccess(res, {
      member: memberData,
      renewal_eligible: true,
      message: 'Member data retrieved successfully for renewal'
    }, 'Member data retrieved for renewal');

  } catch (error) {
    next(error);
  }
});

/**
 * POST /api/v1/renewals/process
 * Process membership renewal with payment
 * PUBLIC ENDPOINT - No authentication required for self-service renewals
 */
router.post('/process', async (req: Request, res: Response, next: NextFunction) => {
  try {
    console.log(`ðŸ”„ Processing self-service renewal...`);

    // Validate request body
    const { error, value } = renewalProcessSchema.validate(req.body);
    if (error) {
      throw new ValidationError(error.details[0].message);
    }

    const {
      id_number,
      payment_method,
      payment_reference,
      amount_paid,
      updated_member_data
    } = value as RenewalPaymentData;

    // Step 1: Get member information
    const memberQuery = `
      SELECT
        m.member_id,
        m.id_number,
        m.firstname,
        m.surname,
        ms.membership_id,
        ms.membership_number,
        ms.expiry_date
      FROM members m
      LEFT JOIN memberships ms ON m.member_id = ms.member_id
      WHERE m.id_number = $1
    `;

    const member = await executeQuerySingle<any>(memberQuery, [id_number]);

    if (!member) {
      throw new NotFoundError(`Member with ID number ${id_number} not found`);
    }

    // Step 2: Update member details if provided
    if (updated_member_data && Object.keys(updated_member_data).length > 0) {
      const updateFields: string[] = [];
      const updateValues: any[] = [];
      let paramIndex = 1;

      if (updated_member_data.email !== undefined) {
        updateFields.push(`email = $${paramIndex++}`);
        updateValues.push(updated_member_data.email);
      }
      if (updated_member_data.cell_number !== undefined) {
        updateFields.push(`cell_number = $${paramIndex++}`);
        updateValues.push(updated_member_data.cell_number);
      }
      if (updated_member_data.landline_number !== undefined) {
        updateFields.push(`landline_number = $${paramIndex++}`);
        updateValues.push(updated_member_data.landline_number);
      }
      if (updated_member_data.residential_address !== undefined) {
        updateFields.push(`residential_address = $${paramIndex++}`);
        updateValues.push(updated_member_data.residential_address);
      }
      if (updated_member_data.postal_address !== undefined) {
        updateFields.push(`postal_address = $${paramIndex++}`);
        updateValues.push(updated_member_data.postal_address);
      }
      if (updated_member_data.ward_code !== undefined) {
        updateFields.push(`ward_code = $${paramIndex++}`);
        updateValues.push(updated_member_data.ward_code);
      }

      if (updateFields.length > 0) {
        updateFields.push(`updated_at = CURRENT_TIMESTAMP`);
        updateValues.push(member.member_id);

        const updateMemberQuery = `
          UPDATE members
          SET ${updateFields.join(', ')}
          WHERE member_id = $${paramIndex}
        `;

        await executeQuery(updateMemberQuery, updateValues);
      }
    }

    // Step 3: Calculate new dates
    const currentDate = new Date();
    const lastPaymentDate = currentDate.toISOString().split('T')[0]; // YYYY-MM-DD format
    
    // Calculate expiry date as 24 months (730 days) from last_payment_date
    const expiryDate = new Date(currentDate);
    expiryDate.setDate(expiryDate.getDate() + 730); // 24 months = 730 days
    const newExpiryDate = expiryDate.toISOString().split('T')[0];

    // Step 4: Update membership dates
    const updateMembershipQuery = `
      UPDATE memberships
      SET
        last_payment_date = $1,
        expiry_date = $2,
        status_id = 1,
        updated_at = CURRENT_TIMESTAMP
      WHERE member_id = $3
    `;

    await executeQuery(updateMembershipQuery, [lastPaymentDate, newExpiryDate, member.member_id]);

    // Step 5: Create payment record for self-service renewal
    const paymentReferenceValue = payment_reference || `REN-${Date.now()}-${member.member_id}`;

    const insertPaymentQuery = `
      INSERT INTO payments (
        member_id,
        membership_id,
        payment_reference,
        payment_method,
        payment_type,
        amount,
        currency,
        payment_status,
        payment_date,
        verification_notes,
        created_at,
        updated_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
      RETURNING payment_id
    `;

    const verificationNote = `Self-service renewal via member portal`;

    const paymentResult = await executeQuerySingle<{ payment_id: number }>(
      insertPaymentQuery,
      [
        member.member_id,
        member.membership_id,
        paymentReferenceValue,
        payment_method,
        'Renewal',
        amount_paid,
        'ZAR',
        'Completed',
        currentDate,
        verificationNote
      ]
    );

    // Step 6: Get updated member data
    const updatedMemberQuery = `
      SELECT
        m.member_id,
        m.id_number,
        m.firstname,
        m.surname,
        m.email,
        m.cell_number,
        ms.membership_number,
        ms.date_joined,
        ms.last_payment_date,
        ms.expiry_date,
        ms.status_id,
        mst.status_name
      FROM members m
      LEFT JOIN memberships ms ON m.member_id = ms.member_id
      LEFT JOIN membership_statuses mst ON ms.status_id = mst.status_id
      WHERE m.member_id = $1
    `;

    const updatedMember = await executeQuerySingle<any>(updatedMemberQuery, [member.member_id]);

    // Return success response
    sendSuccess(res, {
      member: updatedMember,
      payment: {
        payment_id: paymentResult?.payment_id,
        payment_reference: paymentReferenceValue,
        amount_paid,
        payment_method,
        payment_date: lastPaymentDate
      },
      renewal_details: {
        last_payment_date: lastPaymentDate,
        expiry_date: newExpiryDate,
        renewal_period: '24 months'
      }
    }, 'Membership renewed successfully');

  } catch (error) {
    next(error);
  }
});

export default router;

